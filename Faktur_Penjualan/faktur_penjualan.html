<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Faktur Penjualan - PT. Agro Mapan Sentosa</title>
<link rel="stylesheet" href="faktur_penjualan.css">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* tambahan style untuk form & layout */
.container{display:flex;flex-wrap:wrap;gap:20px}
.left{flex:1 1 320px; min-width:280px}
.right{flex:1 1 420px; min-width:320px; border:1px solid #eee; padding:14px; border-radius:8px; background:#fafafa}
.field{margin-bottom:10px}
.label{font-size:13px;color:#333;margin-bottom:4px}
.input, select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
.table{width:100%; border-collapse:collapse; margin-top:12px}
.table th, .table td{border:1px solid #ccc; padding:8px; text-align:left}
.controls{margin-top:12px; display:flex; gap:8px}
.btn{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
.btn-primary{background:#1f8dd6;color:white}
.btn-ghost{background:#fff;border:1px solid #bbb}
.summary{margin-top:12px}
.summary-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
.no-print{display:block}
@media print{
  .no-print{display:none !important}
  body{margin:0}
  .right{border:0;background:transparent}
}
.logo-small{height:50px}
</style>
</head>
<body>
<h2>PT. AGRO MAPAN SENTOSA</h2>
<p>Jln Raya Rawajitu Selatan â€” agromapansentosa@gmail.com</p>

<div class="container">
  <!-- LEFT: Form Input -->
  <div class="left">
    <div class="field">
      <div class="label">No. Faktur</div>
      <input id="inv_no_in" class="input" value="INV-2025-001">
    </div>

    <div style="display:flex;gap:8px">
      <div style="flex:1" class="field">
        <div class="label">Tanggal</div>
        <input id="date_in" type="date" class="input">
      </div>
      <div style="flex:1" class="field">
        <div class="label">Jatuh Tempo</div>
        <input id="due_in" type="date" class="input">
      </div>
    </div>

    <div class="field">
      <div class="label">Pelanggan (nama / alamat)</div>
      <textarea id="customer_in" class="input" rows="3">Contoh Pelanggan&#10;Alamat Pelanggan</textarea>
    </div>

    <hr>

    <h4>Daftar Item</h4>
    <div id="items_container">
      <!-- rows inserted by JS -->
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="item_name" class="input" placeholder="Nama produk / deskripsi">
      <input id="item_qty" class="input" placeholder="Qty" inputmode="numeric">
      <input id="item_price" class="input" placeholder="Harga/unit" inputmode="numeric">
      <button class="btn btn-primary" onclick="addItem()">Tambah</button>
    </div>

    <div style="margin-top:12px">
      <div class="field">
        <div class="label">Diskon (%)</div>
        <input id="discount_pct" class="input" value="0" inputmode="numeric">
      </div>
      <div class="field">
        <div class="label">PPN (%)</div>
        <input id="tax_pct" class="input" value="11" inputmode="numeric">
      </div>
    </div>

    <div class="controls no-print">
      <button class="btn btn-primary" onclick="applyToInvoice()">Terapkan ke Faktur</button>
      <button class="btn btn-ghost" onclick="resetForm()">Reset Form</button>
	  <button class="btn btn-ghost" onclick="sendToAppsScriptJSONP()">Simpan ke Drive & Catat</button>

    </div>
  </div>

  <!-- RIGHT: Invoice Preview / Cetak -->
  <div class="right" id="invoice_area">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <img src="../logo_agro_mapan.png" class="logo-small" alt="logo">
        <h3 style="margin:6px 0 0 0">PT. AGRO MAPAN SENTOSA</h3>
        <div>Jln Raya Rawajitu Selatan</div>
        <div>Email: agromapansentosa@gmail.com</div>
      </div>
      <div style="text-align:right">
        <div>No: <strong id="inv_no">INV-2025-001</strong></div>
        <div>Tanggal: <span id="date">2025-10-17</span></div>
        <div>Jatuh Tempo: <span id="due">2025-10-30</span></div>
      </div>
    </div>

    <hr>
    <div><strong>Tagihan Kepada:</strong><div id="customer">Contoh Pelanggan<br>Alamat Pelanggan</div></div>

    <table class="table" id="invoice_table">
      <thead><tr><th>No</th><th>Produk</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr></thead>
      <tbody id="invoice_items"></tbody>
    </table>

    <div class="summary">
      <div class="summary-row"><div>Subtotal</div><div>Rp <span id="subtotal">0</span></div></div>
      <div class="summary-row"><div>Diskon (<span id="discount_pct_view">0</span>%)</div><div>- Rp <span id="discount_amount">0</span></div></div>
      <div class="summary-row"><div>PPN (<span id="tax_pct_view">11</span>%)</div><div>Rp <span id="tax_amount">0</span></div></div>
      <div class="summary-row" style="font-weight:bold"><div>Grand Total</div><div>Rp <span id="grand_total">0</span></div></div>
    </div>

    <div style="margin-top:10px" class="no-print">
      <button class="btn btn-primary" onclick="printInvoice()">Cetak / Simpan PDF</button>
    </div>
	
  </div>
</div>

<script>
// init dates
(function(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('date_in').value = yyyy+'-'+mm+'-'+dd;
  // default due +14 days
  const due = new Date(today.getTime() + 14*24*60*60*1000);
  const dy = due.getFullYear(), dm = String(due.getMonth()+1).padStart(2,'0'), dd2 = String(due.getDate()).padStart(2,'0');
  document.getElementById('due_in').value = dy+'-'+dm+'-'+dd2;
  // set preview dates
  document.getElementById('date').textContent = document.getElementById('date_in').value;
  document.getElementById('due').textContent = document.getElementById('due_in').value;
  // default tax view
  document.getElementById('tax_pct_view').textContent = document.getElementById('tax_pct').value;
})();

// items in-memory
let items = [];

// helper
function fmt(x){ return Number(x||0).toLocaleString('id-ID'); }

function addItem(){
  const name = document.getElementById('item_name').value.trim();
  const qty = Number(document.getElementById('item_qty').value) || 0;
  const price = Number(document.getElementById('item_price').value) || 0;
  if(!name){ alert('Isi nama produk'); return; }
  if(qty<=0){ alert('Qty harus > 0'); return; }
  items.push({name, qty, price});
  document.getElementById('item_name').value=''; document.getElementById('item_qty').value=''; document.getElementById('item_price').value='';
  renderItemsList();
}

function renderItemsList(){
  const cont = document.getElementById('items_container');
  cont.innerHTML = '';
  items.forEach((it, i)=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='6px';
    row.innerHTML = `<div style="flex:1">${i+1}. <strong>${it.name}</strong></div>
      <div style="width:70px;text-align:right">${it.qty}</div>
      <div style="width:120px;text-align:right">Rp ${fmt(it.price)}</div>
      <div style="width:120px;text-align:right">Rp ${fmt(it.qty*it.price)}</div>
      <div><button class="btn btn-ghost" onclick="removeItem(${i})">Hapus</button></div>`;
    cont.appendChild(row);
  });
  updatePreview();
}

function removeItem(idx){ items.splice(idx,1); renderItemsList(); }

function updatePreview(){
  // update preview table
  const tbody = document.getElementById('invoice_items');
  tbody.innerHTML = '';
  let subtotal = 0;
  items.forEach((it,i)=>{
    const tr = document.createElement('tr');
    const sub = it.qty * it.price;
    subtotal += sub;
    tr.innerHTML = `<td>${i+1}</td><td>${it.name}</td><td>${it.qty}</td><td>Rp ${fmt(it.price)}</td><td>Rp ${fmt(sub)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('subtotal').textContent = fmt(subtotal);
  // discount
  const discPct = Number(document.getElementById('discount_pct').value) || 0;
  const discAmount = Math.round(subtotal * discPct / 100);
  document.getElementById('discount_pct_view').textContent = discPct;
  document.getElementById('discount_amount').textContent = fmt(discAmount);
  // tax
  const taxPct = Number(document.getElementById('tax_pct').value) || 0;
  const taxable = subtotal - discAmount;
  const taxAmount = Math.round(taxable * taxPct / 100);
  document.getElementById('tax_amount').textContent = fmt(taxAmount);
  document.getElementById('tax_pct_view').textContent = taxPct;
  // grand total
  const grand = taxable + taxAmount;
  document.getElementById('grand_total').textContent = fmt(grand);
}

function applyToInvoice(){
  // set header fields
  document.getElementById('inv_no').textContent = document.getElementById('inv_no_in').value || document.getElementById('inv_no').textContent;
  document.getElementById('date').textContent = document.getElementById('date_in').value || document.getElementById('date').textContent;
  document.getElementById('due').textContent = document.getElementById('due_in').value || document.getElementById('due').textContent;
  document.getElementById('customer').innerText = document.getElementById('customer_in').value;
  // update calculations
  updatePreview();
  alert('Data diterapkan ke faktur. Silakan klik Cetak jika ingin menyimpan PDF.');
}

function resetForm(){
  if(!confirm('Reset semua item dan isian form?')) return;
  items = [];
  renderItemsList();
  document.getElementById('inv_no_in').value='INV-2025-001';
  // reset dates to today/due+14
  const today = new Date();
  const yyyy = today.getFullYear(), mm = String(today.getMonth()+1).padStart(2,'0'), dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('date_in').value = yyyy+'-'+mm+'-'+dd;
  const due = new Date(today.getTime()+14*24*60*60*1000); document.getElementById('due_in').value = due.getFullYear()+'-'+String(due.getMonth()+1).padStart(2,'0')+'-'+String(due.getDate()).padStart(2,'0');
  document.getElementById('customer_in').value = 'Contoh Pelanggan\nAlamat Pelanggan';
  document.getElementById('discount_pct').value = 0;
  document.getElementById('tax_pct').value = 11;
  applyToInvoice();
}

function printInvoice(){
  // open print dialog for invoice_area only
  window.print();
}

// live update when discount or tax changed
document.getElementById('discount_pct').addEventListener('input', updatePreview);
document.getElementById('tax_pct').addEventListener('input', updatePreview);

// also update preview when date/customer inputs change
document.getElementById('customer_in').addEventListener('input', ()=>{ document.getElementById('customer').innerText = document.getElementById('customer_in').value; });
document.getElementById('date_in').addEventListener('change', ()=>{ document.getElementById('date').textContent = document.getElementById('date_in').value; });
document.getElementById('due_in').addEventListener('change', ()=>{ document.getElementById('due').textContent = document.getElementById('due_in').value; });

// initial render
renderItemsList();

/* --- JSONP send function (paste ke dalam <script> di faktur_penjualan.html) --- */
function sendToAppsScriptJSONP(){
 // ====== CONFIG - GANTI INI ======
const SHEET_ID = '15GwYHXDGaOhh-0fnRgNaLAc9xA-i1YwIK8Ns5lZkqFM';
const DRIVE_FOLDER_ID = '1Q0k_oARh64oERQ67S5Y-vldKsNDQEgIo'; // kosongkan jika tidak pakai folder khusus
// ===============================

/*
  JSONP handler: menerima parameter 'd' (payload JSON, url-encoded)
  payload.items = [{product_code, name, qty, price, subtotal}, ...]
*/
function doGet(e){
  var callback = e.parameter.callback || 'callback';
  var response = { status: 'error', message: 'No data' };

  if(e.parameter.d){
    try {
      var payload = JSON.parse(decodeURIComponent(e.parameter.d));
      // validate minimal fields
      if(!payload.invoice_no) throw new Error('Missing invoice_no');
      if(!payload.items || payload.items.length === 0) throw new Error('No items');

      // open spreadsheet and sheets
      var ss = SpreadsheetApp.openById(SHEET_ID);
      var stockSheet = ss.getSheetByName('Stock');
      var moveSheet = ss.getSheetByName('Stock_Movements');
      var invoiceSheet = ss.getSheetByName('Invoices') || ss.getSheets()[0];

      if(!stockSheet) throw new Error('Sheet "Stock" not found. Buat sheet dengan header: product_code, product_name, stock_qty, unit_cost');
      if(!moveSheet) throw new Error('Sheet "Stock_Movements" not found. Buat sheet dengan header: timestamp, product_code, product_name, change, type, ref_invoice, note');

      // read stock into map (for faster lookup)
      var stockData = stockSheet.getDataRange().getValues(); // includes header
      var stockMap = {}; // product_code -> {row, product_name, stock_qty}
      for(var i=1;i<stockData.length;i++){
        var r = stockData[i];
        var code = String(r[0]||'').trim();
        if(!code) continue;
        stockMap[code] = {
          row: i+1, // sheet row index (1-based)
          product_name: r[1] || '',
          stock_qty: Number(r[2] || 0),
          unit_cost: Number(r[3] || 0)
        };
      }

      // 1) Validation pass: check stock availability for all items
      var insufficient = [];
      for(var j=0;j<payload.items.length;j++){
        var it = payload.items[j];
        var code = (it.product_code || '').trim();
        var qty = Number(it.qty || it.quantity || it.q || 0);
        if(!code){
          insufficient.push({item: it, reason: 'missing product_code'});
          continue;
        }
        var entry = stockMap[code];
        if(!entry){
          insufficient.push({item: it, reason: 'product not found in stock: ' + code});
          continue;
        }
        if(qty > entry.stock_qty){
          insufficient.push({item: it, reason: 'insufficient stock for ' + code + ' (have ' + entry.stock_qty + ', need ' + qty + ')'});
          continue;
        }
      }

      if(insufficient.length > 0){
        // return error, do not modify anything
        response = { status:'error', message: 'Stok tidak mencukupi / validasi gagal', details: insufficient };
        var txt = callback + '(' + JSON.stringify(response) + ');';
        return ContentService.createTextOutput(txt).setMimeType(ContentService.MimeType.JAVASCRIPT);
      }

      // 2) All OK => perform updates: reduce stock & append movement rows
      var now = new Date();
      var movements = []; // collect rows to append
      for(var k=0;k<payload.items.length;k++){
        var it2 = payload.items[k];
        var code2 = (it2.product_code || '').trim();
        var qty2 = Number(it2.qty || it2.quantity || it2.q || 0);
        if(!code2) continue;
        var mapEnt = stockMap[code2];
        // update in-memory and sheet later
        mapEnt.stock_qty = mapEnt.stock_qty - qty2;
        stockMap[code2] = mapEnt;
        movements.push([ formatDateTime(now), code2, mapEnt.product_name, -qty2, 'sale', payload.invoice_no, 'Auto reduced by invoice' ]);
      }

      // Write back updated stock quantities (batch)
      var updates = [];
      for(var key in stockMap){
        var ent = stockMap[key];
        // collect row, new qty
        updates.push({row: ent.row, qty: ent.stock_qty});
      }
      // apply updates
      updates.forEach(function(u){
        stockSheet.getRange(u.row, 3).setValue(u.qty); // column C = stock_qty (col 3)
      });

      // append movements (one per item)
      if(movements.length>0){
        moveSheet.getRange(moveSheet.getLastRow()+1, 1, movements.length, movements[0].length).setValues(movements);
      }

      // 3) Save invoice summary to invoiceSheet (appendRow)
      var invRow = [
        payload.invoice_no,
        payload.date || '',
        payload.due || '',
        payload.customer || '',
        payload.subtotal || 0,
        payload.discount_pct || 0,
        payload.tax_pct || 0,
        payload.grand_total || 0,
        '' // pdf link placeholder
      ];
      invoiceSheet.appendRow(invRow);

      // Optionally: create PDF and save to Drive (if DRIVE_FOLDER_ID set)
      var pdfUrl = '';
      try {
        if(typeof payload.items !== 'undefined' && payload.items.length>0){
          var html = buildInvoiceHtml(payload);
          var pdfBlob = HtmlService.createHtmlOutput(html).getBlob().setName(payload.invoice_no + '.pdf');
          var file;
          if(DRIVE_FOLDER_ID){
            var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
            file = folder.createFile(pdfBlob);
          } else {
            file = DriveApp.createFile(pdfBlob);
          }
          pdfUrl = file.getUrl();
          // update last invoice row with pdfUrl (last row)
          var lastRow = invoiceSheet.getLastRow();
          invoiceSheet.getRange(lastRow, 9).setValue(pdfUrl);
        }
      } catch(pdfErr){
        // ignore pdf errors but include in response
        pdfUrl = '';
      }

      response = { status:'ok', message: 'Invoice saved and stock updated', pdfUrl: pdfUrl };
    } catch(errMain){
      response = { status:'error', message: errMain.message };
    }
  }

  var out = callback + '(' + JSON.stringify(response) + ');';
  return ContentService.createTextOutput(out).setMimeType(ContentService.MimeType.JAVASCRIPT);
}


// helper: build minimal invoice HTML (used for PDF)
function buildInvoiceHtml(d){
  var rows = '';
  (d.items||[]).forEach(function(it,i){
    rows += '<tr><td style="border:1px solid #ccc;padding:6px">'+(i+1)+'</td><td style="border:1px solid #ccc;padding:6px">'+escapeHtml(it.name||it.product_name||'')+'</td><td style="border:1px solid #ccc;padding:6px;text-align:right">'+it.qty+'</td><td style="border:1px solid #ccc;padding:6px;text-align:right">'+Number(it.price||0).toLocaleString('id-ID')+'</td><td style="border:1px solid #ccc;padding:6px;text-align:right">'+Number(it.subtotal||0).toLocaleString('id-ID')+'</td></tr>';
  });
  return '<html><body style="font-family:Arial;font-size:12px"><h2>PT. AGRO MAPAN SENTOSA</h2><div>No: '+escapeHtml(d.invoice_no)+'</div><div>Tanggal: '+escapeHtml(d.date||'')+'</div><div><strong>Pelanggan:</strong><br/>'+escapeHtml(d.customer||'').replace(/\n/g,'<br/>')+'</div><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th style="border:1px solid #ccc;padding:6px">No</th><th style="border:1px solid #ccc;padding:6px">Produk</th><th style="border:1px solid #ccc;padding:6px;text-align:right">Qty</th><th style="border:1px solid #ccc;padding:6px;text-align:right">Harga</th><th style="border:1px solid #ccc;padding:6px;text-align:right">Subtotal</th></tr></thead><tbody>'+rows+'</tbody></table><div style="margin-top:8px">Subtotal: Rp '+Number(d.subtotal||0).toLocaleString('id-ID')+'</div><div>Diskon: '+(d.discount_pct||0)+'%</div><div>PPN: '+(d.tax_pct||0)+'%</div><div style="font-weight:bold">Grand Total: Rp '+Number(d.grand_total||0).toLocaleString('id-ID')+'</div></body></html>';
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function formatDateTime(dt){
  if(!dt) dt = new Date();
  return Utilities.formatDate(dt, Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');
}

}


</script>
</body>
</html>
